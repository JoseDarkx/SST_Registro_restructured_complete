<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Capacitaciones | SST-AnalyTIC</title>
    <link rel="stylesheet" href="../static/css/capacitaciones.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar">
    <h2>SST-AnalyTIC</h2>
    <ul>
        <li><a href="/dashboard" class="menu-link">Inicio</a></li>

        <li class="section-title">GESTIÓN PRINCIPAL</li>
        <li><a href="/capacitaciones" class="menu-link">Capacitaciones</a></li>
        <li><a href="/evaluaciones_medicas" class="menu-link">Evaluaciones Médicas</a></li>
        <li><a href="/matriz_iper" class="menu-link">Matriz IPER</a></li>
        <li><a href="//control_epp" class="menu-link">Gestión EPP</a></li>
        <li><a href="/normas_legales" class="menu-link">Normas Legales</a></li>
        <li><a href="/firma_digital" class="menu-link">Firma Digital</a></li>
        <li><a href="/solicitudes_contrasena" class="menu-link">Solicitudes Contraseña</a></li>

        <li class="section-title">ADMINISTRACIÓN</li>
        <li><a href="/empresas" class="menu-link">Empresas</a></li>
        <li><a href="/usuarios" class="menu-link">Usuarios</a></li>
        <li><a href="/visualizacion_global" class="menu-link">Visualización Global</a></li>
        <li><a href="/formatos_globales" class="menu-link">Formatos Globales</a></li>
        <li><a href="/documentacion" class="menu-link">Documentación</a></li>

        <li class="section-title">GESTIÓN DE PERSONAL</li>
        <li><a href="/visualizacion_filtros" class="menu-link">Visualización y Filtros</a></li>
        <li><a href="/planes_accion" class="menu-link">Planes de Acción</a></li>
        <li><a href="/incidentes_accidentes" class="menu-link">Incidentes y Accidentes</a></li>
        <li><a href="/historial_cambios" class="menu-link">Historial de Cambios</a></li>
      
</div>

    <div class="container mt-4" style="margin-left: 250px;">
        <!-- Mensajes flash -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ 'danger' if category == 'error' else 'success' }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <div class="card shadow-sm p-4">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>Listado de Capacitaciones</h2>
                <div class="d-flex gap-2">
                    <button class="btn btn-outline-primary" data-bs-toggle="collapse" data-bs-target="#filtros">
                        <i class="fas fa-filter"></i> Filtros
                    </button>
                    <button class="btn btn-primary" data-bs-toggle="collapse" data-bs-target="#nuevaCapacitacion">
                        <i class="fas fa-plus"></i> Nueva Capacitación
                    </button>
                </div>
            </div>

            <!-- Filtros (colapsable) -->
            <div class="collapse mb-4" id="filtros">
                <div class="card card-body">
                    <form method="GET" class="row g-3">
                        <div class="col-md-4">
                            <label class="form-label">Empresa</label>
                            <select name="empresa" class="form-select">
                                <option value="">Todas las empresas</option>
                                {% for empresa in empresas %}
                                    <option value="{{ empresa.nit_empresa }}">{{ empresa.nombre }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Estado</label>
                            <select name="estado" class="form-select">
                                <option value="">Todos los estados</option>
                                <option value="Programada">Programada</option>
                                <option value="En curso">En curso</option>
                                <option value="Terminada">Terminada</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Desde</label>
                            <input type="date" name="fecha_desde" class="form-control">
                        </div>
                        <div class="col-md-2 d-flex align-items-end">
                            <button type="submit" class="btn btn-outline-secondary me-2">Filtrar</button>
                            <a href="/capacitaciones" class="btn btn-outline-danger">Limpiar</a>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Estadísticas rápidas -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card bg-primary text-white">
                        <div class="card-body text-center">
                            <h4>{{ capacitaciones|length }}</h4>
                            <p class="mb-0">Total Capacitaciones</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-warning text-white">
                        <div class="card-body text-center">
                            <h4>{{ capacitaciones|selectattr('estado', 'equalto', 'Programada')|list|length }}</h4>
                            <p class="mb-0">Programadas</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-info text-white">
                        <div class="card-body text-center">
                            <h4>{{ capacitaciones|selectattr('estado', 'equalto', 'En curso')|list|length }}</h4>
                            <p class="mb-0">En Curso</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-success text-white">
                        <div class="card-body text-center">
                            <h4>{{ capacitaciones|selectattr('estado', 'equalto', 'Terminada')|list|length }}</h4>
                            <p class="mb-0">Terminadas</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tabla de capacitaciones -->
            <div class="table-responsive mb-4">
                <table class="table table-bordered table-hover">
                    <thead class="table-light">
                        <tr>
                            <th>ID</th>
                            <th>Empresa</th>
                            <th>Fecha</th>
                            <th>Responsable</th>
                            <th>Estado</th>
                            <th>Evaluaciones</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if capacitaciones %}
                            {% for capacitacion in capacitaciones %}
                            <tr>
                                <td>{{ capacitacion.id }}</td>
                                <td>{{ capacitacion.nombre_empresa }}</td>
                                <td>{{ capacitacion.fecha.strftime('%d/%m/%Y') if capacitacion.fecha else '' }}</td>
                                <td>{{ capacitacion.responsable }}</td>
                                <td>
                                    {% if capacitacion.estado == 'Programada' %}
                                        <span class="badge bg-secondary">Programada</span>
                                    {% elif capacitacion.estado == 'En curso' %}
                                        <span class="badge bg-info text-dark">En curso</span>
                                    {% else %}
                                        <span class="badge bg-success">Terminada</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-outline-info" onclick="verEvaluaciones({{ capacitacion.id }})">
                                        <i class="fas fa-eye"></i> Ver
                                    </button>
                                </td>
                                <td>
                                    <div class="btn-group" role="group">
                                        <a href="/editar_capacitacion/{{ capacitacion.id }}" class="btn btn-primary btn-sm">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                        <button class="btn btn-danger btn-sm" onclick="eliminarCapacitacion({{ capacitacion.id }})">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        {% else %}
                            <tr>
                                <td colspan="7" class="text-center text-muted">No hay capacitaciones registradas</td>
                            </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>

            <!-- Formulario para crear nueva capacitación (colapsable) -->
            <div class="collapse" id="nuevaCapacitacion">
                <div class="card card-body mb-4">
                    <h4>Nueva Capacitación</h4>
                    <form method="POST" action="/crear_capacitacion">
                        <div class="row">
                            <div class="col-md-3 mb-3">
                                <label>Empresa</label>
                                <select name="empresa" class="form-select" required>
                                    <option value="">Seleccione...</option>
                                    {% for empresa in empresas %}
                                        <option value="{{ empresa.nit_empresa }}">{{ empresa.nombre }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label>Fecha</label>
                                <input type="date" name="fecha" class="form-control" required>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label>Responsable</label>
                                <input type="text" name="responsable" class="form-control" required>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label>Estado</label>
                                <select name="estado" class="form-select">
                                    <option value="Programada">Programada</option>
                                    <option value="En curso">En curso</option>
                                    <option value="Terminada">Terminada</option>
                                </select>
                            </div>
                        </div>
                        <div class="d-flex justify-content-end">
                            <button type="button" class="btn btn-secondary me-2" data-bs-toggle="collapse" data-bs-target="#nuevaCapacitacion">Cancelar</button>
                            <button type="submit" class="btn btn-success">Guardar</button>
                        </div>
                    </form>
                </div>
            </div>

            <hr class="my-5">

            <!-- Evaluaciones de la capacitación -->
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4>Evaluaciones de Capacitación</h4>
                <a href="/agregar_evaluacion" class="btn btn-outline-primary">
                    <i class="fas fa-plus"></i> Agregar Evaluación
                </a>
            </div>
            
            <div class="table-responsive mb-3">
                <table class="table table-bordered">
                    <thead class="table-light">
                        <tr>
                            <th>Participante</th>
                            <th>Pre-test</th>
                            <th>Post-test</th>
                            <th>Resultado</th>
                            <th>Fecha</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if evaluaciones %}
                            {% for evaluacion in evaluaciones %}
                            <tr>
                                <td>{{ evaluacion.participante }}</td>
                                <td>{{ "%.1f"|format(evaluacion.pre_test) if evaluacion.pre_test else 'N/A' }}%</td>
                                <td>{{ "%.1f"|format(evaluacion.post_test) if evaluacion.post_test else 'N/A' }}%</td>
                                <td>
                                    {% if evaluacion.resultado == 'Aprobado' %}
                                        <span class="text-success fw-bold"><i class="fas fa-check-circle"></i> Aprobado</span>
                                    {% elif evaluacion.resultado == 'No aprobado' %}
                                        <span class="text-danger fw-bold"><i class="fas fa-times-circle"></i> No aprobado</span>
                                    {% else %}
                                        <span class="text-warning fw-bold"><i class="fas fa-exclamation-circle"></i> Requiere</span>
                                    {% endif %}
                                </td>
                                <td>{{ evaluacion.fecha_evaluacion.strftime('%d/%m/%Y') if evaluacion.fecha_evaluacion else '' }}</td>
                                <td>
                                    <a href="/editar_evaluacion/{{ evaluacion.id }}" class="btn btn-info btn-sm">
                                        <i class="fas fa-edit"></i> Editar
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        {% else %}
                            <tr>
                                <td colspan="6" class="text-center text-muted">No hay evaluaciones registradas</td>
                            </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>

            <hr class="my-5">

            <!-- Reporte de efectividad -->
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div>
                    <h4>Reporte de Efectividad</h4>
                    <p class="text-muted">Genera reportes de impacto de las capacitaciones según resultados.</p>
                </div>
                <div class="d-flex gap-2">
                    <a href="/reporte_capacitaciones_pdf" class="btn btn-danger">
                        <i class="fas fa-file-pdf"></i> Generar PDF
                    </a>
                    <a href="/reporte_capacitaciones_excel" class="btn btn-success">
                        <i class="fas fa-file-excel"></i> Exportar Excel
                    </a>
                </div>
            </div>

            <!-- Gráfico de efectividad simple -->
            <div class="row">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0">Resumen de Evaluaciones</h6>
                        </div>
                        <div class="card-body">
                            {% set total_evaluaciones = evaluaciones|length %}
                            {% set aprobados = evaluaciones|selectattr('resultado', 'equalto', 'Aprobado')|list|length %}
                            {% set no_aprobados = evaluaciones|selectattr('resultado', 'equalto', 'No aprobado')|list|length %}
                            {% set requieren = evaluaciones|selectattr('resultado', 'equalto', 'Requiere')|list|length %}
                            
                            <div class="row text-center">
                                <div class="col">
                                    <h5 class="text-success">{{ aprobados }}</h5>
                                    <small>Aprobados</small>
                                </div>
                                <div class="col">
                                    <h5 class="text-warning">{{ requieren }}</h5>
                                    <small>Requieren</small>
                                </div>
                                <div class="col">
                                    <h5 class="text-danger">{{ no_aprobados }}</h5>
                                    <small>No aprobados</small>
                                </div>
                            </div>
                            
                            {% if total_evaluaciones > 0 %}
                                <div class="mt-3">
                                    <div class="progress">
                                        <div class="progress-bar bg-success" style="width: {{ (aprobados / total_evaluaciones * 100)|round(1) }}%"></div>
                                        <div class="progress-bar bg-warning" style="width: {{ (requieren / total_evaluaciones * 100)|round(1) }}%"></div>
                                        <div class="progress-bar bg-danger" style="width: {{ (no_aprobados / total_evaluaciones * 100)|round(1) }}%"></div>
                                    </div>
                                    <small class="text-muted">Efectividad: {{ (aprobados / total_evaluaciones * 100)|round(1) }}%</small>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- Modal para ver evaluaciones -->
    <div class="modal fade" id="modalEvaluaciones" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Evaluaciones de Capacitación</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="contenidoEvaluaciones">
                    <!-- Contenido se carga dinámicamente -->
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <script>
        // Función para eliminar capacitación
        function eliminarCapacitacion(id) {
            Swal.fire({
                title: '¿Estás seguro?',
                text: "Esta acción no se puede deshacer",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Sí, eliminar',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    fetch(`/eliminar_capacitacion/${id}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            Swal.fire('Eliminado', data.message, 'success').then(() => {
                                location.reload();
                            });
                        } else {
                            Swal.fire('Error', data.message, 'error');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        Swal.fire('Error', 'Error al eliminar la capacitación', 'error');
                    });
                }
            });
        }

        // Función para ver evaluaciones de una capacitación
        function verEvaluaciones(capacitacionId) {
            fetch(`/api/capacitaciones/${capacitacionId}/evaluaciones`)
            .then(response => response.json())
            .then(data => {
                if (data.evaluaciones) {
                    let contenido = '<div class="table-responsive"><table class="table table-sm">';
                    contenido += '<thead><tr><th>Participante</th><th>Pre-test</th><th>Post-test</th><th>Resultado</th></tr></thead><tbody>';
                    
                    if (data.evaluaciones.length === 0) {
                        contenido += '<tr><td colspan="4" class="text-center text-muted">No hay evaluaciones para esta capacitación</td></tr>';
                    } else {
                        data.evaluaciones.forEach(eval => {
                            let badgeClass = eval.resultado === 'Aprobado' ? 'success' : eval.resultado === 'Requiere' ? 'warning' : 'danger';
                            contenido += `<tr>
                                <td>${eval.participante}</td>
                                <td>${eval.pre_test ? eval.pre_test + '%' : 'N/A'}</td>
                                <td>${eval.post_test ? eval.post_test + '%' : 'N/A'}</td>
                                <td><span class="badge bg-${badgeClass}">${eval.resultado}</span></td>
                            </tr>`;
                        });
                    }
                    
                    contenido += '</tbody></table></div>';
                    document.getElementById('contenidoEvaluaciones').innerHTML = contenido;
                    new bootstrap.Modal(document.getElementById('modalEvaluaciones')).show();
                } else {
                    Swal.fire('Error', 'Error al cargar las evaluaciones', 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                Swal.fire('Error', 'Error al cargar las evaluaciones', 'error');
            });
        }

        // Auto-cerrar alertas después de 5 segundos
        setTimeout(() => {
            const alerts = document.querySelectorAll('.alert');
            alerts.forEach(alert => {
                const bsAlert = new bootstrap.Alert(alert);
                bsAlert.close();
            });
        }, 5000);
    </script>
</body>
</html>