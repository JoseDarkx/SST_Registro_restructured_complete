<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Dashboard Administrador</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Font Awesome -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

  <!-- CSS personalizado -->
  <link rel="stylesheet" href="..//static/css/dashboard.css">

  <!-- Chart.js para los gráficos -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <div class="d-flex">
    
    <!-- Sidebar -->
    <nav class="sidebar text-white p-3" style="width: 250px; background-color: #5d79d4; min-height: 100vh;">
      <h5 class="mb-4">SST-AnalyTIC</h5>
      <ul class="nav flex-column">
        <!-- Menú lateral con secciones -->
        <li><a href="/dashboard" class="menu-link">Inicio</a></li>

        <li class="section-title">GESTIÓN PRINCIPAL</li>
        <li><a href="/capacitaciones" class="menu-link">Capacitaciones</a></li>
        <li><a href="/evaluaciones_medicas" class="menu-link">Evaluaciones Médicas</a></li>
        <li><a href="/matriz_iper" class="menu-link">Matriz IPER</a></li>
        <li><a href="//control_epp" class="menu-link">Gestión EPP</a></li>
        <li><a href="/normas_legales" class="menu-link">Normas Legales</a></li>
        <li><a href="/firma_digital" class="menu-link">Firma Digital</a></li>
        <li><a href="/solicitudes_contrasena" class="menu-link">Solicitudes Contraseña</a></li>

        <li class="section-title">ADMINISTRACIÓN</li>
        <li><a href="/empresas" class="menu-link">Empresas</a></li>
        <li><a href="/usuarios" class="menu-link">Usuarios</a></li>
        <li><a href="/visualizacion_global" class="menu-link">Visualización Global</a></li>
        <li><a href="/formatos_globales" class="menu-link">Formatos Globales</a></li>
        <li><a href="/documentacion" class="menu-link">Documentación</a></li>

        <li class="section-title">GESTIÓN DE PERSONAL</li>
        <li><a href="/visualizacion_filtros" class="menu-link">Visualización y Filtros</a></li>
        <li><a href="/planes_accion" class="menu-link">Planes de Acción</a></li>
        <li><a href="/incidentes_accidentes" class="menu-link">Incidentes y Accidentes</a></li>
        <li><a href="/historial_cambios" class="menu-link">Historial de Cambios</a></li>
      </ul>
    </nav>

    <!-- Contenido principal -->
    <div class="content flex-grow-1">

      <!-- Barra superior -->
      <header class="bg-light d-flex justify-content-between align-items-center px-4 py-2 border-bottom">
        <div><strong>Panel principal / Dashboard</strong></div>
        <div class="text-end">
          <div>{{ usuario_actual.nombre_completo }}</div>
          <div class="text-muted small">{{ usuario_actual.rol }}</div>
          <a href="{{ url_for('cerrar_sesion') }}">
            <img src="{{ url_for('static', filename='img/logout-icon.png') }}" alt="Salir" width="20">
          </a>
        </div>
      </header>

      <div class="container-fluid mt-4">

        <!-- Filtro por empresa -->
        <form method="GET" class="mb-4">
          <label for="nit_empresa"><strong>Filtrar por Empresa:</strong></label>
          <select name="nit_empresa" id="nit_empresa" class="form-select w-25 d-inline-block" onchange="this.form.submit()">
            <option value="">-- Todas las Empresas --</option>
            {% for empresa in empresas %}
              <option value="{{ empresa.nit_empresa }}" {% if empresa.nit_empresa == nit_seleccionado %}selected{% endif %}>
                {{ empresa.nombre }} ({{ empresa.nit_empresa }})
              </option>
            {% endfor %}
          </select>
        </form>

        <!-- Tarjetas resumen -->
        <div class="row mb-4">
          <div class="col-md-4">
            <div class="card bg-primary text-white">
              <div class="card-body">
                <h5>Total Empresas</h5>
                <p class="fs-3">{{ total_empresas }}</p>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="card bg-success text-white">
              <div class="card-body">
                <h5>Evaluaciones Activas</h5>
                <p class="fs-3">{{ total_evaluaciones }}</p>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="card bg-warning text-white">
              <div class="card-body">
                <h5>Capacitaciones Pendientes</h5>
                <p class="fs-3">{{ total_capacitaciones }}</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Gráficos -->
        <div class="row">
          <div class="col-md-6">
            <div class="card shadow-sm">
              <div class="card-body">
                <h5>Incidentes por Tipo</h5>
                <canvas id="graficoIncidentes"></canvas>
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="card shadow-sm">
              <div class="card-body">
                <h5>Estado de Documentos</h5>
                <canvas id="graficoDocumentos"></canvas>
              </div>
            </div>
          </div>
        </div>

      </div> <!-- cierre container-fluid -->

    </div> <!-- cierre contenido -->

  </div> <!-- cierre wrapper -->

  <!-- Script para gráficos -->
  <script>
    // Gráfico de Incidentes por Tipo
    const ctxIncidentes = document.getElementById('graficoIncidentes');
    new Chart(ctxIncidentes, {
      type: 'bar',
      data: {
        labels: {{ incidentes_por_tipo | map(attribute='tipo') | list | tojson }},
        datasets: [{
          label: 'Cantidad',
          data: {{ incidentes_por_tipo | map(attribute='cantidad') | list | tojson }},
          backgroundColor: ['#0077b6', '#90e0ef', '#03045e']
        }]
      }
    });

    // Gráfico de Estado de Documentos
    const ctxDocumentos = document.getElementById('graficoDocumentos');
    new Chart(ctxDocumentos, {
      type: 'doughnut',
      data: {
        labels: {{ documentos_por_estado | map(attribute='estado') | list | tojson }},
        datasets: [{
          label: 'Cantidad',
          data: {{ documentos_por_estado | map(attribute='cantidad') | list | tojson }},
          backgroundColor: ['#80ed99', '#f9c74f', '#ff6b6b', '#adb5bd', '#4dabf7']
        }]
      }
    });
  </script>

</body>
</html>

